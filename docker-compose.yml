services:
  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: app
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  api:
    build:
      context: ./apps/api
    environment:
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD_HASH: ${ADMIN_PASSWORD_HASH}
      ADMIN_BOOTSTRAP_TOKEN: ${ADMIN_BOOTSTRAP_TOKEN}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      GITHUB_APP_ID: ${GITHUB_APP_ID}
      GITHUB_APP_PRIVATE_KEY_PEM: ${GITHUB_APP_PRIVATE_KEY_PEM}
      GITHUB_APP_PRIVATE_KEY_PATH: ${GITHUB_APP_PRIVATE_KEY_PATH}
      GITHUB_INSTALLATION_ID: ${GITHUB_INSTALLATION_ID}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET}
      GITHUB_API_BASE: ${GITHUB_API_BASE:-https://api.github.com}
      ENABLE_TEST_ENDPOINTS: ${ENABLE_TEST_ENDPOINTS:-false}
      MCP_SHARED_SECRET: ${MCP_SHARED_SECRET}
      MCP_BASE_URL: http://mcp:3333
    ports:
      - "8000:8000"
    depends_on:
      - db

  web:
    build:
      context: ./apps/web
    environment:
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
    ports:
      - "3000:3000"
    depends_on:
      - api

  mcp:
    build:
      context: ./apps/mcp
    environment:
      API_BASE_URL: http://api:8000
      MCP_SHARED_SECRET: ${MCP_SHARED_SECRET}
      MCP_ADMIN_TOKEN: ${MCP_ADMIN_TOKEN}
    expose:
      - "3333"
    depends_on:
      - api

  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: ai-supervisor-openwebui
    restart: unless-stopped
    environment:
      - WEBUI_AUTH=true
      - WEBUI_NAME=AI Supervisor Control
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ENABLE_OPENAI_API=true
    volumes:
      - openwebui_data:/app/backend/data
    ports:
      - "127.0.0.1:8080:8080"
    depends_on:
      - api
      - mcp

volumes:
  pgdata:
  openwebui_data:
